#!/usr/bin/perl

use strict;
use warnings;

use EBox;
use EBox::Global;

EBox::init();

my $sambaModule = EBox::Global->modInstance('samba');
my $usersModule = EBox::Global->modInstance('users');

while (1) {
    my $sambaUserList = $sambaModule->ldb->users();
    my $sambaGroupList = $sambaModule->ldb->groups();
    my %sambaUsers = map { $_->get('samAccountName') => $_ } @{$sambaUserList};
    my %sambaGroups = map { $_->get('samAccountName') => $_ } @{$sambaGroupList};

    my $zentyalUserList = $usersModule->users();
    my $zentyalGroupList = $usersModule->groups();
    my %zentyalUsers = map { $_->get('uid') => $_ } @{$zentyalUserList};
    my %zentyalGroups = map { $_->get('cn') => $_ } @{$zentyalGroupList};

    foreach my $sambaUserName (keys %sambaUsers) {
        next if exists $zentyalUsers{$sambaUserName};
        $sambaUsers{$sambaUserName}->addToZentyal();
    }

    foreach my $sambaGroupName (keys %sambaGroups) {
        next if exists $zentyalGroups{$sambaGroupName};
        $sambaGroups{$sambaGroupName}->addToZentyal();
        $sambaGroups{$sambaGroupName}->membersToZentyal();
    }

    sleep (3);
}
