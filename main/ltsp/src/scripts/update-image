#!/usr/bin/perl -s

use strict;
use warnings;

use EBox;
use EBox::Global;

if (scalar @ARGV == 1) {
    my $arch = $ARGV[0];
    if ( -f "/opt/ltsp/images/$arch.img" ) {
        EBox::init();

        my $ltsp = EBox::Global->modInstance('ltsp');

        $ltsp->st_set_string('arch', $arch);
        $ltsp->st_set_string('work', 'update');
        print "Updating $arch image...\n";

        my $CHROOT_DIR = "/opt/ltsp/$arch";
        EBox::Sudo::root("chroot $CHROOT_DIR mount -t proc none /proc "
                         . "&& chroot $CHROOT_DIR apt-get update "
                         . "&& chroot $CHROOT_DIR env LTSP_HANDLE_DAEMONS=false apt-get dist-upgrade -y "
                         . "&& umount /opt/ltsp/$arch/proc "
                         . "&& ltsp-update-kernels "
                         . "&& ltsp-update-image --arch $arch");
        $ltsp->st_set_string('work', 'none');
    } else {
        print "/opt/ltsp/images/$arch.img does not exist.\n";
    }
} else {
    print "Usage: build-image arch\n";
}
